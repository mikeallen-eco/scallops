---
title: "Scallop Dynamic Occupancy - half degree"
author: "Mike Allen"
date: '2022-11-2'
output: html_document
---

# Load libraries and format data
Note: the "dat" object in this chunk must be created using the code in analyze_scallop_grid2.R first.
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)

train_years <- 1983:2014
test_years <- 2004:2014

# read and format in climate data
clim_avg <- read.csv("processed-data/climate_formatted.csv") %>%
    group_by(grid, year) %>%
    summarise(across(where(is.numeric), mean),
              .groups = "drop") %>%
  mutate(grid_lat = as.numeric(substr(grid,1,5)),
         grid_lon = as.numeric(substr(grid,6,11)))

# covariate data from Morely
clim_other <- readRDS("data_noaa/trawl/hauls.rds") %>%
  filter(region %in% c("NEFSC_NEUS")) %>%
  mutate(grid_lat = case_when(lat-trunc(lat)<0.5 ~ trunc(lat)+0.25,
                              lat-trunc(lat)>=0.5 ~ 
                                trunc(lat)+0.75),
         grid_lon = case_when(abs(lon-trunc(lon))<0.5 ~ 
                                trunc(lon)-0.25,
                              abs(lon-trunc(lon))>=0.5 ~ 
                                trunc(lon)-0.75),
         grid = paste0(grid_lat,grid_lon)) %>%
    filter(grid %in% unique(clim_avg$grid),
         year %in% unique(clim_avg$year)) %>%
    group_by(grid, year) %>%
    summarise(across(where(is.numeric), mean, na.rm = T),
              .groups = "drop") %>%
  select(-latgrid, -longrid, -yearsurv, -lat, -lon, month) %>%
  arrange(grid, year)

# prep dat dens data, excluding smaller scallops (< 80 mm)
# note: "dat" here must be created in analyze_scallop_grid2.R first
dat_dens80_occ <- dat %>% 
  filter(is.na(length) | length >= 8) %>%
  group_by(haulid, grid, patch, year) %>% 
  summarise(dens = sum(number_at_length, na.rm = F),
            .groups = "drop") %>%
  arrange(patch, grid, year, haulid) %>%
  group_by(grid, patch, year) %>%
  summarise(pres = sum(dens>0, na.rm = T),
            presb = sum(dens>27, na.rm = T), # 28 is top 5% of hauls
            n = sum(haulid!="temp", na.rm = T),
            .groups = "drop") %>%
  mutate(pres = as.numeric(ifelse(n==0, NA, pres)),
         presb = as.numeric(ifelse(n==0, NA, presb))) %>%
  left_join(clim_avg, by = c("grid", "year")) %>%
  left_join(clim_other, by = c("grid", "year", 
                               "grid_lat", "grid_lon")) %>%
  filter(year != 1979) %>%
  group_by(grid) %>%
  mutate(mean_depth = mean(depth, na.rm = T)) %>%
  arrange(grid, year) %>%
  mutate(min_tempL1 = lag(min_temp),
         max_tempL1 = lag(max_temp),
         mean_tempL1 = lag(mean_temp),
         min_tempL2 = lag(min_temp,2),
         max_tempL2 = lag(max_temp,2),
         mean_tempL2 = lag(mean_temp,2),
         min_tempL3 = lag(min_temp,3),
         max_tempL3 = lag(max_temp,3),
         mean_tempL3 = lag(mean_temp,3),
         O2L1 = lag(O2),
         O2L2 = lag(O2,2),
         O2L3 = lag(O2,3)) %>%
  select(grid, year, pres, presb, n, grid_lon, grid_lat, 
         min_temp, min_tempL1, min_tempL2, min_tempL3,
         mean_temp, mean_tempL1, mean_tempL2, mean_tempL3,
         max_temp, max_tempL1, max_tempL2, max_tempL3,
         O2, O2L1, O2L2, O2L3, mean_depth) %>%
  ungroup()

dat_train_dens80_occ <- dat_dens80_occ %>% 
  filter(year %in% train_years) 

# dat_test_dens80_occ <- dat_dens80_occ %>% 
#   filter(year %in% test_years) 

# matrix of number of "detected" samples per cell and year
ymat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = pres) %>%
  select(-grid) %>%
  as.matrix()

# matrix of number of "detected" samples per cell and year 
    # including only those that were "bonanzas" (top 5% of hauls)
ymatb <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = presb) %>%
  select(-grid) %>%
  as.matrix()

ymat_gridnames <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = pres) %>%
  select(grid)

nmat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = n) %>%
  select(-grid) %>%
  as.matrix()
nmat[is.na(nmat)] <- 0

meansbt_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_temp) %>%
  select(-grid) %>%
  as.matrix() 
# fill in NA with mean (doesn't matter as all correspond with NA ymat)
meansbt_mat[is.na(meansbt_mat)] <- mean(meansbt_mat, na.rm = T)

meansbtL1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_tempL1) %>%
  select(-grid) %>%
  as.matrix() 
meansbtL1_mat[is.na(meansbtL1_mat)] <- mean(meansbtL1_mat, na.rm = T)

meansbtL2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_tempL2) %>%
  select(-grid) %>%
  as.matrix() 
meansbtL2_mat[is.na(meansbtL2_mat)] <- mean(meansbtL2_mat, na.rm = T)

meansbtL3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_tempL3) %>%
  select(-grid) %>%
  as.matrix() 
meansbtL3_mat[is.na(meansbtL3_mat)] <- mean(meansbtL3_mat, na.rm = T)

# meansbt_mat_test <- dat_test_dens80_occ %>%
#   select(grid, year, mean_temp) %>%
#   # need to do this because we want all years (even with no hauls)
#   # for prediction
#   right_join(expand.grid(grid = unique(dat_test_dens80_occ$grid),
#                          year = test_years)) %>%
#   left_join(clim_avg, by = c("grid", "year")) %>%
#   select(grid, year, mean_temp = mean_temp.y) %>%
#   pivot_wider(id_cols = grid,
#               names_from = year,
#               values_from = mean_temp) %>%
#   select(-grid) %>%
#   as.matrix() 

maxsbt_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_temp) %>%
  select(-grid) %>%
  as.matrix() 
maxsbt_mat[is.na(maxsbt_mat)] <- mean(maxsbt_mat, na.rm = T)

maxsbtL1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_tempL1) %>%
  select(-grid) %>%
  as.matrix() 
maxsbtL1_mat[is.na(maxsbtL1_mat)] <- mean(maxsbtL1_mat, na.rm = T)

maxsbtL2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_tempL2) %>%
  select(-grid) %>%
  as.matrix() 
maxsbtL2_mat[is.na(maxsbtL2_mat)] <- mean(maxsbtL2_mat, na.rm = T)

maxsbtL3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_tempL3) %>%
  select(-grid) %>%
  as.matrix() 
maxsbtL3_mat[is.na(maxsbtL3_mat)] <- mean(maxsbtL3_mat, na.rm = T)

minsbt_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_temp) %>%
  select(-grid) %>%
  as.matrix() 
minsbt_mat[is.na(minsbt_mat)] <- mean(minsbt_mat, na.rm = T)

minsbtL1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_tempL1) %>%
  select(-grid) %>%
  as.matrix() 
minsbtL1_mat[is.na(minsbtL1_mat)] <- mean(minsbtL1_mat, na.rm = T)

minsbtL2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_tempL2) %>%
  select(-grid) %>%
  as.matrix() 
minsbtL2_mat[is.na(minsbtL2_mat)] <- mean(minsbtL2_mat, na.rm = T)

minsbtL3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_tempL3) %>%
  select(-grid) %>%
  as.matrix() 
minsbtL3_mat[is.na(minsbtL3_mat)] <- mean(minsbtL3_mat, na.rm = T)

O2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2) %>%
  select(-grid) %>%
  as.matrix() 
O2_mat[is.na(O2_mat)] <- mean(O2_mat, na.rm = T)

O2L1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2L1) %>%
  select(-grid) %>%
  as.matrix() 
O2L1_mat[is.na(O2L1_mat)] <- mean(O2L1_mat, na.rm = T)

O2L2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2L2) %>%
  select(-grid) %>%
  as.matrix() 
O2L2_mat[is.na(O2L2_mat)] <- mean(O2L2_mat, na.rm = T)

O2L3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2L3) %>%
  select(-grid) %>%
  as.matrix() 
O2L3_mat[is.na(O2L3_mat)] <- mean(O2L3_mat, na.rm = T)

depth_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_depth) %>%
  select(-grid) %>%
  as.matrix()
depth_mat[is.na(depth_mat)] <- mean(depth_mat, na.rm = T)

```
# data exploration
```{r}
# correlation among mean SBT, O2, and depth
cor(cbind(dat_dens80_occ$mean_temp, dat_dens80_occ$O2, dat_dens80_occ$mean_depth))
#            [,1]       [,2]       [,3]
# [1,]  1.0000000  0.1675016 -0.5597515
# [2,]  0.1675016  1.0000000 -0.7768805
# [3,] -0.5597515 -0.7768805  1.0000000

# plot scallop occ vs. mean SBT and O2
dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_temp, y = pres/n,
             color = mean_depth)) + 
  geom_point(size = 3, alpha = .7) +
  scale_color_viridis_c(option = "inferno") +
  labs(y = "% of tows")
# ggsave("figures/niche/occ_v_meanSBT_depth.png",
       # height = 6, width = 6, dpi = 400)

dat_train_dens80_occ %>% 
  filter(n>=3) %>% 
  ggplot(aes(x = mean_temp, y = pres/n,
             color = O2)) + 
  geom_point(size = 3, alpha = .7) +
  scale_color_viridis_c(option = "inferno") +
  labs(y = "% of tows")
# ggsave("figures/niche/occ_v_meanSBT_O2.png",
#        height = 6, width = 6, dpi = 400)

meanplot <- dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  mutate(pct = pres/n) %>%
  group_by(grid) %>%
  summarize(
    mean_temp = mean(mean_temp),
    O2 = mean(O2),
    depth = mean(mean_depth),
    pct = mean(pct),
    pres = sum(pres),
    n = sum(n),
            .groups = "drop") 

meanplot %>%
  ggplot(aes(y = mean_temp, x = depth,
             color = O2)) + 
  geom_point(size = 5) +
  geom_point(data = filter(meanplot, pct>0.35),
             aes(y = mean_temp, x = depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  scale_color_viridis_c(option = "inferno")

meanplot %>%
  ggplot(aes(y = O2, x = depth,
             color = mean_temp)) + 
  geom_point(size = 5) +
  geom_point(data = filter(meanplot, pct>0.5),
             aes(y = O2, x = depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  scale_color_viridis_c(option = "inferno")

dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_depth, y = O2,
             color = mean_temp)) + 
  geom_point(size = 3, alpha = .7) +
  geom_point(data = filter(dat_train_dens80_occ, (pres/n)>0.8),
             aes(y = O2, x = mean_depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  scale_color_viridis_c(option = "inferno") +
  theme_bw()

dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_depth, y = mean_temp,
             color = O2)) + 
  geom_point(size = 4, alpha = .5) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(pres/n)>=0.8),
             aes(y = mean_temp, x = mean_depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  labs(x = "Mean depth (m)", y = "Mean bottom temperature (C)") +
  scale_color_viridis_c(option = "inferno") +
  theme_bw()

ggsave("figures/dynocc/scal_pres_v_temp_O2.png", 
       height = 4, width = 6, dpi = 400)

```
# Define the model (psi.sbt.o2, phi.sbt.o2, gam.sbt.o2)
```{r}

cat(file = "scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt", 
    "
model{
  for(i in 1:nSites) {
    # biological process
    lpsi1[i] <- lpsiInt + betapsiO2*O2a[i,1]
    psi1[i] <- ilogit(lpsi1[i])*exp(-0.5*((climvar1[i,1]-Topt1)/width1)^2)
    z[i, 1] ~ dbern(psi1[i])
    for(t in 2:nYears) {
      lphi[i, t-1] <- lphiInt[t-1] + betaphiO2*O2b[i,t-1]
      phi[i, t-1] <-
        ilogit(lphi[i,t-1])*exp(-0.5*((climvar2[i,t-1]-Topt2)/width2)^2)
      lgam[i, t-1] <- lgamInt[t-1] + betagamO2*O2c[i,t-1]
      gamma[i, t-1] <- 
        ilogit(lgam[i, t-1])*exp(-0.5*((climvar3[i,t-1]-Topt3)/width3)^2)
      z[i, t] ~ dbern(z[i, t-1]*phi[i, t-1] +
          (1 - z[i, t-1])*gamma[i, t-1])
   }
    # detection process
    for(t in 1:nYears) {
      y[i, t] ~ dbin(p[t] * z[i, t], n[i, t])
    }
  }

  # Priors
  psiInt ~ dbeta(1, 1)
  lpsiInt <- logit(psiInt)

  for(t in 1:(nYears-1)) {
    phiInt[t] ~ dbeta(1, 1)
    lphiInt[t] <- logit(phiInt[t])
    gamInt[t] ~ dbeta(1, 1)
    lgamInt[t] <- logit(gamInt[t])
  }

  for(t in 1:nYears) {
    p[t] ~ dbeta(1, 1)
  }

  Topt1 ~ dnorm(8,16)
  width1 ~ dnorm(5,10)
  Topt2 ~ dnorm(8,16)
  width2 ~ dnorm(5,10)
  Topt3 ~ dnorm(8,16)
  width3 ~ dnorm(5,10)
  betapsiO2 ~ dnorm(0,5)
  betaphiO2 ~ dnorm(0,5)
  betagamO2 ~ dnorm(0,5)

  # Derived variable
  for(t in 1:nYears) {
    N[t] <- sum(z[,t]) # no. sites occupied for each year
  }
  
}
")
```
# Bundle data for JAGS & run models
# LAG 0 for Persistence; LAGS 0-3 for Colonization
# Mean, Max, Min SBT hypothesis
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)

jdata <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbt_mat, z = z, depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS)
str(jdata)

jdataL0L1 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS)
str(jdataL0L1)

jdataL0L2 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L2_matS)
str(jdataL0L2)

jdataL0L3 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L3_matS)
str(jdataL0L3)

wanted <- c("psiInt", "phiInt", "gamInt", "p", "Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", "N", "gamma", "phi",
            "betapsiO2", "betaphiO2", "betagamO2")

# lag 0 for all variables
# psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2
( psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2 <- 
    jagsUI::jags(jdata, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2,
        "output/psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2.rds")

# psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2
( psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2 <- 
    jagsUI::jags(jdataL0L1, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2,
        "output/psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2.rds")

# psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2
( psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2 <- 
    jagsUI::jags(jdataL0L2, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2,
        "output/psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2.rds")

# psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2
( psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2 <- 
    jagsUI::jags(jdataL0L3, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2,
        "output/psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2.rds")
```
# Bundle data for JAGS & run models (mean SBT only)
# LAG 0 for Persistence; LAGS 0-3 for Colonization
# Mean, mean, mean SBT hypothesis
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)

jdata_L0mean <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbt_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS)
str(jdata_L0mean)

jdataL0L1a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS)
str(jdataL0L1a)

jdataL0L2a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = meansbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L2_matS)
str(jdataL0L2)

jdataL0L3a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L3_matS)
str(jdataL0L3a)

wanted <- c("psiInt", "phiInt", "gamInt", "p", "Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", "N", "gamma", "phi",
            "betapsiO2", "betaphiO2", "betagamO2")

# psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2
( psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2 <- 
    jagsUI::jags(jdata_L0mean, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2 <- 
    jagsUI::jags(jdataL0L1a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2 <- 
    jagsUI::jags(jdataL0L2a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2 <- 
    jagsUI::jags(jdataL0L3a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.rds")
```



# Bundle data for JAGS & run models
# LAG 1 for Persistence; LAG 1 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
depth_matS <- wiqid::standardize(depth_mat)

jdataL1L1 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbtL1_mat, 
    climvar3 = minsbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2L1_matS, O2c = o2L1_matS)
str(jdataL1L1)

wanted <- c("psiInt", "phiInt", "gamInt", "p", "Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", "N", "gamma", "phi",
            "betapsiO2", "betaphiO2", "betagamO2")

# psi.meansbt.phi.maxsbtL1.gam.minsbtL1
( psi.meansbt.phi.maxsbtL1.gam.minsbtL1 <- 
    jagsUI::jags(jdataL1L1, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.phi.sbt.gam.sbt.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.phi.maxsbtL1.gam.minsbtL1,
        "output/psi.meansbt.phi.maxsbtL1.gam.minsbtL1.rds")

# psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL1.o2
( psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL1.o2 <- 
    jagsUI::jags(jdataL1L1, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL1.o2,
        "output/psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL1.o2.rds")
```
# Bundle data for JAGS & run models
# LAG 1 for Persistence; LAG 2 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
depth_matS <- wiqid::standardize(depth_mat)

jdataL1L2 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbtL1_mat, 
    climvar3 = minsbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2L1_matS, O2c = o2L2_matS)
str(jdataL1L2)

wanted <- c("psiInt", "phiInt", "gamInt", "p", "Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", "N", "gamma", "phi",
            "betapsiO2", "betaphiO2", "betagamO2")

# psi.meansbt.phi.maxsbtL1.gam.minsbtL2
( psi.meansbt.phi.maxsbtL1.gam.minsbtL2 <- 
    jagsUI::jags(jdataL1L2, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.phi.sbt.gam.sbt.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.phi.maxsbtL1.gam.minsbtL2,
        "output/psi.meansbt.phi.maxsbtL1.gam.minsbtL2.rds")

# psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL2.o2
( psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL2.o2 <- 
    jagsUI::jags(jdataL1L2, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL2.o2,
        "output/psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL2.o2.rds")

# psi.meansbt.depth.phi.maxsbtL1.depth.gam.minsbtL2.depth
jdataL1L2_depth <- jdataL1L2
jdataL1L2_depth$O2 <- jdataL1L2$depth
( psi.meansbt.depth.phi.maxsbtL1.depth.gam.minsbtL2.depth <- 
    jagsUI::jags(jdataL1L2_depth, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.depth.phi.maxsbtL1.depth.gam.minsbtL2.depth,
  "output/psi.meansbt.depth.phi.maxsbtL1.depth.gam.minsbtL2.depth.rds")
```
# Bundle data for JAGS & run models
# LAG 1 for Persistence; LAG 3 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)

jdataL1L3 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbtL1_mat, 
    climvar3 = minsbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2L1_matS, O2c = o2L3_matS)
str(jdataL1L3)

wanted <- c("psiInt", "phiInt", "gamInt", "p", "Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", "N", "gamma", "phi",
            "betapsiO2", "betaphiO2", "betagamO2")

# psi.meansbt.phi.maxsbtL1.gam.minsbtL2
( psi.meansbt.phi.maxsbtL1.gam.minsbtL3 <- 
    jagsUI::jags(jdataL1L3, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.phi.sbt.gam.sbt.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.phi.maxsbtL1.gam.minsbtL3,
        "output/psi.meansbt.phi.maxsbtL1.gam.minsbtL3.rds")

# psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL3.o2
( psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL3.o2 <- 
    jagsUI::jags(jdataL1L3, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL3.o2,
        "output/psi.meansbt.o2.phi.maxsbtL1.o2.gam.minsbtL3.o2.rds")

```
# check model output
```{r}

psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2.rds")
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$Topt1
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$width1
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$Topt2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$width2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$Topt3
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$width3
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$betapsiO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$betaphiO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$mean$betagamO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$q2.5$betagamO2
psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2$q97.5$betagamO2

psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2.rds")
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$Topt1
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$width1
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$Topt2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$width2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$Topt3
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$width3
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$mean$betagamO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$q2.5$betagamO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2$q97.5$betagamO2

psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2.rds")
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$Topt1
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$width1
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$Topt2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$width2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$Topt3
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$width3
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$mean$betagamO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$q2.5$betagamO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2$q97.5$betagamO2

psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2.rds")
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$Topt1
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$width1
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$Topt2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$width2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$Topt3
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$width3
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$mean$betagamO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$q2.5$betagamO2
psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2$q97.5$betagamO2

# model runs with only mean SBT

psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.rds")
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$Topt1
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$width1
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$Topt2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$width2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$Topt3
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$width3
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$betapsiO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$betaphiO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$mean$betagamO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$q2.5$betagamO2
psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2$q97.5$betagamO2

psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.rds")
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$Topt1
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$width1
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$Topt2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$width2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$Topt3
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$width3
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$betagamO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q2.5$betagamO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q97.5$betagamO2

psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.rds")
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$Topt1
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$width1
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$Topt2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$width2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$Topt3
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$width3
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$mean$betagamO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$q2.5$betagamO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2$q97.5$betagamO2

psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2 <- 
  readRDS("output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.rds")
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$Topt1
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$width1
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$Topt2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$width2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$Topt3
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$width3
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$q2.5$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$q97.5$betapsiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$q2.5$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$q97.5$betaphiO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$mean$betagamO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$q2.5$betagamO2
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2$q97.5$betagamO2



```
# Map mean colonization - extinction by patch
```{r}
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2 <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p

# to check that apply worked right
# colext.m <- psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$gamma - (1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$phi)

# get mean & q2.5 of posterior for col - ext by cell and year
colext.mean.by.year = apply(colext.p, c(2,3), mean)
colext.q2.5.by.year = apply(colext.p, c(2,3), function(x)quantile(x, 0.025))

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q1.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.01))
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q10.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.10))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q1 = colext.q1.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q10 = colext.q10.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map estimated change in scallop abundance per 1-2
colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "x") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction\n(1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))

ggsave("figures/dynocc/scallop_dynocc_predicted_colext.png",
        height = 5, width = 5, dpi = 400)
```
# map scallop abundance (1983-1997) & (1999-2014)
```{r}

obs80_rmean_train1 <- dat_train_dens80 %>%
  arrange(patch, year) %>%
  mutate(year = year + 1979,
         obs80 = mean_dens) %>%
  filter(year %in% 1983:1998) %>%
  group_by(grid) %>%
  summarize(mean_dens = mean(mean_dens, na.rm = T)) %>%
  mutate(grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

obs80_rmean_train2 <- dat_train_dens80 %>%
  arrange(patch, year) %>%
  mutate(year = year + 1979,
         obs80 = mean_dens) %>%
  filter(year %in% 1999:2014) %>%
  group_by(grid) %>%
  summarize(mean_dens = mean(mean_dens, na.rm = T)) %>%
  mutate(grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

# map observed density, 1983-1998  
ggplot() +
  geom_tile(aes(x = lon, y = lat, fill = mean_dens),
            data = obs80_rmean_train1,
            color = "black") +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8)) +
  viridis::scale_color_viridis(option = "inferno") +
  labs(x = "", y = "", fill = "Mean n\nper tow\n(80mm+)",
       title = "Observed density, 1983-1998") + 
  scale_fill_viridis_c(option = "inferno",
                       limits = c(0,520)) +
  theme(text = element_text(size = 14),
        title = element_text(size = 12)) 

ggsave("figures/dynocc/obsdens80_1983_1998.png", 
       height = 6, width = 6, dpi = 400)

# map observed density, 1999-2014  
ggplot() +
  geom_tile(aes(x = lon, y = lat, fill = mean_dens),
            data = obs80_rmean_train2,
            color = "black") +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8)) +
  viridis::scale_color_viridis(option = "inferno") +
  labs(x = "", y = "", fill = "Mean n\nper tow\n(80mm+)",
       title = "Observed density, 1999-2014") + 
  scale_fill_viridis_c(option = "inferno",
                       limits = c(0,520)) +
  theme(text = element_text(size = 14),
        title = element_text(size = 12)) 

ggsave("figures/dynocc/obsdens80_1999_2014.png", 
       height = 6, width = 6, dpi = 400)


```



# plot effects - Gaussian mean SBT model
```{r}
out_meansbt_gaus <- readRDS("output/out_meansbt_gaus4.rds")
# out_meansbt_gaus <- readRDS("output/out_meansbt_gaus_O2.rds")

plot(out_meansbt_gaus$mean$N, type = "l")

range(meansbt_mat)  #  3.983414 18.407284
cx <- seq(4, 18.4, length=101)

params <- out_meansbt_gaus$mean

lpsix <- with(params, qlogis(psiInt))
psix <- plogis(lpsix)*(exp(-0.5*((cx-params$Topt1)/params$width1)^2))
plot(cx, psix, type='l', lwd=2,
    xlab="Mean SBT", ylab="Initial occupancy, psi")

lphix <- matrix(NA, 101, 37)
for(i in 1:37) {
  lphix[,i] <- with(params, qlogis(phiInt[i]))
phix <- plogis(lphix)*(exp(-0.5*((cx-params$Topt2)/params$width2)^2))
matplot(cx, phix, type='l', lty=1, lwd=2,
    xlab="Mean SBT", ylab="Persistence, phi")
}

lgamx <- matrix(NA, 101, 37)
for(i in 1:37){
  lgamx[,i] <- with(params, qlogis(gamInt[i]))
gamx <- plogis(lgamx)*(exp(-0.5*((cx-params$Topt3)/params$width3)^2))
matplot(cx, gamx, type='l', lty=1, lwd=2,
    xlab="Mean SBT", ylab="Colonisation, gamma")
}

ldiffx <- matrix(NA, 101, 37)
for(i in 1:37){
    lgamx[,i] <- with(params, qlogis(gamInt[i]))
    lphix[,i] <- with(params, qlogis(phiInt[i]))
phix <- plogis(lphix)*(exp(-0.5*((cx-params$Topt2)/params$width2)^2))
gamx <- plogis(lgamx)*(exp(-0.5*((cx-params$Topt3)/params$width3)^2))
extx <- 1-phix
diffx <- gamx - extx
matplot(cx, diffx, type='l', lty=1, lwd=2,
    xlab="Mean SBT", ylab="Colonisation - Extinction")
abline(h = 0, lty = 2)
}
```
# Mapping mean Colonization - Extinction (test period)
```{r}
out <- readRDS("output/out_meansbt_gaus4.rds")

colext_mat <- apply(out$sims.list$colminusext_proj, c(2,3), median)
colext_mean <- apply(colext_mat, 1, mean) %>%
  as.data.frame() %>%
  rename(colext = 1) %>%
  mutate(grid = unique(dat_train_dens80_occ$grid)) %>%
  mutate(grid_lat = as.numeric(substr(grid, 1, 4)),
         grid_lon = as.numeric(substr(grid, 5, 9)),
         lat = grid_lat,
         lon = grid_lon) %>%
  sf::st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext_mean)

ggplot() +
  geom_tile(aes(x = lon, y = lat, fill = colext),
            # alpha = 1,
            data = colext_mean,
            color = "black") +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8)) +
  labs(x = "", y = "", fill = "Mean predicted\ncolonization - extinction rate\n(2005-2014)",
       title = "Dynamic occupancy model\n(based on mean SBT)") + 
  scale_fill_gradient2(midpoint = 0, 
                       low = "steelblue", 
                       mid = "white",
                       high = "firebrick", space = "Lab") +
  theme(text = element_text(size = 14),
        title = element_text(size = 12))

ggsave("figures/dynocc/projected_colext.png", 
       height = 6, width = 6, dpi = 400)
```





# Map col-ext for training set for model with and without O2
```{r}
out_meansbt_gaus <- readRDS("output/out_meansbt_gaus4.rds")
out_meansbt_gausO2 <- readRDS("output/out_meansbt_gaus_O2.rds")
params_gaus <- out_meansbt_gaus$mean
params_gausO2 <- out_meansbt_gausO2$mean

colext_gaus <- params_gaus$gamma-(1-params_gaus$phi) %>%
  apply(.,1,mean) %>%
  as.data.frame() %>%
  rename(colext = 1)
```

# Mapping change in psi over time
```{r}
# http://www.seec.uct.ac.za/dynamic-occupancy-models
# We estimated occupancy in the first year, \(\Psi_1\). But what about occupancy probabilities in subsequent years? They are derived parameters, calculated as \(\Psi_t = \Psi_{t-1} \times (1-\epsilon_{t-1}) + (1-\Psi_{t-1}) \times \gamma_{t-1}\).

psix <- params$psiInt*(exp(-0.5*((meansbt_mat[,1]-params$Topt1)/params$width1)^2))
phix <- plogis(lphix)*(exp(-0.5*((cx-params$Topt2)/params$width2)^2))
gamx <- plogis(lgamx)*(exp(-0.5*((cx-params$Topt3)/params$width3)^2))
```
