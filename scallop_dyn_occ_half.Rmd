---
title: "Scallop Dynamic Occupancy - half degree"
author: "Mike Allen"
date: '2022-11-2'
output: html_document
---

# Load libraries and format data
Note: the "dat" object in this chunk must be created using the code in analyze_scallop_grid2.R first.
```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)

train_years <- 1983:2014
# test_years <- 2004:2014

# read and format in climate data
clim_avg <- read.csv("processed-data/climate_formatted.csv") %>%
    group_by(grid, year) %>%
    summarise(across(where(is.numeric), mean),
              .groups = "drop") %>%
  mutate(grid_lat = as.numeric(substr(grid,1,5)),
         grid_lon = as.numeric(substr(grid,6,11)))

# read in stratification data
strathalf <- readRDS("processed-data/strathalf.rds")

# covariate data from Morely
clim_other <- readRDS("data_noaa/trawl/hauls.rds") %>%
  filter(region %in% c("NEFSC_NEUS")) %>%
  mutate(grid_lat = case_when(lat-trunc(lat)<0.5 ~ trunc(lat)+0.25,
                              lat-trunc(lat)>=0.5 ~ 
                                trunc(lat)+0.75),
         grid_lon = case_when(abs(lon-trunc(lon))<0.5 ~ 
                                trunc(lon)-0.25,
                              abs(lon-trunc(lon))>=0.5 ~ 
                                trunc(lon)-0.75),
         grid = paste0(grid_lat,grid_lon)) %>%
    filter(grid %in% unique(clim_avg$grid),
         year %in% unique(clim_avg$year)) %>%
    group_by(grid, year) %>%
    summarise(across(where(is.numeric), mean, na.rm = T),
              .groups = "drop") %>%
  select(-latgrid, -longrid, -yearsurv, -lat, -lon, month) %>%
  arrange(grid, year)

# prep dat dens data, excluding smaller scallops (< 80 mm)
# note: "dat" here must be created in analyze_scallop_grid2.R first
dat_dens80_occ <- dat %>% 
  filter(is.na(length) | length >= 8) %>%
  group_by(haulid, grid, patch, year) %>% 
  summarise(dens = sum(number_at_length, na.rm = F),
            .groups = "drop") %>%
  arrange(patch, grid, year, haulid) %>%
  group_by(grid, patch, year) %>%
  summarise(pres = sum(dens>0, na.rm = T),
            presb = sum(dens>27, na.rm = T), # 28 is top 5% of hauls
            n = sum(haulid!="temp", na.rm = T),
            .groups = "drop") %>%
  mutate(pres = as.numeric(ifelse(n==0, NA, pres)),
         presb = as.numeric(ifelse(n==0, NA, presb))) %>%
  left_join(clim_avg, by = c("grid", "year")) %>%
  left_join(clim_other, by = c("grid", "year", 
                               "grid_lat", "grid_lon")) %>%
  left_join(strathalf, by = c("grid", "grid_lat", "grid_lon")) %>%
  filter(year != 1979) %>%
  group_by(grid) %>%
  mutate(mean_depth = mean(depth, na.rm = T)) %>%
  arrange(grid, year) %>%
  mutate(min_tempL1 = lag(min_temp),
         max_tempL1 = lag(max_temp),
         mean_tempL1 = lag(mean_temp),
         min_tempL2 = lag(min_temp,2),
         max_tempL2 = lag(max_temp,2),
         mean_tempL2 = lag(mean_temp,2),
         min_tempL3 = lag(min_temp,3),
         max_tempL3 = lag(max_temp,3),
         mean_tempL3 = lag(mean_temp,3),
         O2L1 = lag(O2),
         O2L2 = lag(O2,2),
         O2L3 = lag(O2,3)) %>%
  select(grid, year, pres, presb, n, grid_lon, grid_lat, 
         min_temp, min_tempL1, min_tempL2, min_tempL3,
         mean_temp, mean_tempL1, mean_tempL2, mean_tempL3,
         max_temp, max_tempL1, max_tempL2, max_tempL3,
         O2, O2L1, O2L2, O2L3, mean_depth, strat) %>%
  ungroup()

dat_train_dens80_occ <- dat_dens80_occ %>% 
  filter(year %in% train_years,
         is.na(strat) == F)

# dat_test_dens80_occ <- dat_dens80_occ %>% 
#   filter(year %in% test_years) 

# matrix of number of "detected" samples per cell and year
ymat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = pres) %>%
  select(-grid) %>%
  as.matrix()

# matrix of number of "detected" samples per cell and year 
    # including only those that were "bonanzas" (top 5% of hauls)
ymatb <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = presb) %>%
  select(-grid) %>%
  as.matrix()

ymat_gridnames <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = pres) %>%
  select(grid)

nmat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = n) %>%
  select(-grid) %>%
  as.matrix()
nmat[is.na(nmat)] <- 0

meansbt_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_temp) %>%
  select(-grid) %>%
  as.matrix() 
# fill in NA with mean (doesn't matter as all correspond with NA ymat)
meansbt_mat[is.na(meansbt_mat)] <- mean(meansbt_mat, na.rm = T)

meansbtL1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_tempL1) %>%
  select(-grid) %>%
  as.matrix() 
meansbtL1_mat[is.na(meansbtL1_mat)] <- mean(meansbtL1_mat, na.rm = T)

meansbtL2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_tempL2) %>%
  select(-grid) %>%
  as.matrix() 
meansbtL2_mat[is.na(meansbtL2_mat)] <- mean(meansbtL2_mat, na.rm = T)

meansbtL3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_tempL3) %>%
  select(-grid) %>%
  as.matrix() 
meansbtL3_mat[is.na(meansbtL3_mat)] <- mean(meansbtL3_mat, na.rm = T)

maxsbt_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_temp) %>%
  select(-grid) %>%
  as.matrix() 
maxsbt_mat[is.na(maxsbt_mat)] <- mean(maxsbt_mat, na.rm = T)

maxsbtL1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_tempL1) %>%
  select(-grid) %>%
  as.matrix() 
maxsbtL1_mat[is.na(maxsbtL1_mat)] <- mean(maxsbtL1_mat, na.rm = T)

maxsbtL2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_tempL2) %>%
  select(-grid) %>%
  as.matrix() 
maxsbtL2_mat[is.na(maxsbtL2_mat)] <- mean(maxsbtL2_mat, na.rm = T)

maxsbtL3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = max_tempL3) %>%
  select(-grid) %>%
  as.matrix() 
maxsbtL3_mat[is.na(maxsbtL3_mat)] <- mean(maxsbtL3_mat, na.rm = T)

minsbt_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_temp) %>%
  select(-grid) %>%
  as.matrix() 
minsbt_mat[is.na(minsbt_mat)] <- mean(minsbt_mat, na.rm = T)

minsbtL1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_tempL1) %>%
  select(-grid) %>%
  as.matrix() 
minsbtL1_mat[is.na(minsbtL1_mat)] <- mean(minsbtL1_mat, na.rm = T)

minsbtL2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_tempL2) %>%
  select(-grid) %>%
  as.matrix() 
minsbtL2_mat[is.na(minsbtL2_mat)] <- mean(minsbtL2_mat, na.rm = T)

minsbtL3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = min_tempL3) %>%
  select(-grid) %>%
  as.matrix() 
minsbtL3_mat[is.na(minsbtL3_mat)] <- mean(minsbtL3_mat, na.rm = T)

O2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2) %>%
  select(-grid) %>%
  as.matrix() 
O2_mat[is.na(O2_mat)] <- mean(O2_mat, na.rm = T)

O2L1_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2L1) %>%
  select(-grid) %>%
  as.matrix() 
O2L1_mat[is.na(O2L1_mat)] <- mean(O2L1_mat, na.rm = T)

O2L2_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2L2) %>%
  select(-grid) %>%
  as.matrix() 
O2L2_mat[is.na(O2L2_mat)] <- mean(O2L2_mat, na.rm = T)

O2L3_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = O2L3) %>%
  select(-grid) %>%
  as.matrix() 
O2L3_mat[is.na(O2L3_mat)] <- mean(O2L3_mat, na.rm = T)

depth_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = mean_depth) %>%
  select(-grid) %>%
  as.matrix()
depth_mat[is.na(depth_mat)] <- mean(depth_mat, na.rm = T)

strat_mat <- dat_train_dens80_occ %>%
  pivot_wider(id_cols = grid,
              names_from = year,
              values_from = strat) %>%
  select(-grid) %>%
  as.matrix()
strat_mat[is.na(strat_mat)] <- mean(strat_mat, na.rm = T)

```
# data exploration
```{r}
# correlation among mean SBT, O2, and depth
cor(cbind(mean_temp = dat_train_dens80_occ$mean_temp,
          O2 = dat_train_dens80_occ$O2, 
          depth = dat_train_dens80_occ$mean_depth,
          strat = dat_train_dens80_occ$strat))
#             mean_temp          O2       depth       strat
# mean_temp  1.00000000  0.29369324 -0.56617935  0.05285505
# O2         0.29369324  1.00000000 -0.81764732  0.02109042
# depth     -0.56617935 -0.81764732  1.00000000 -0.08258975
# strat      0.05285505  0.02109042 -0.08258975  1.00000000

# plot scallop occ vs. mean SBT and O2
dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_temp, y = pres/n,
             color = mean_depth)) + 
  geom_point(size = 3, alpha = .7) +
  scale_color_viridis_c(option = "inferno") +
  labs(y = "% of tows")
# ggsave("figures/niche/occ_v_meanSBT_depth.png",
       # height = 6, width = 6, dpi = 400)

dat_train_dens80_occ %>% 
  filter(n>=3) %>% 
  ggplot(aes(x = mean_temp, y = pres/n,
             color = O2)) + 
  geom_point(size = 3, alpha = .7) +
  scale_color_viridis_c(option = "inferno") +
  labs(y = "% of tows")
# ggsave("figures/niche/occ_v_meanSBT_O2.png",
#        height = 6, width = 6, dpi = 400)

meanplot <- dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  mutate(pct = pres/n) %>%
  group_by(grid) %>%
  summarize(
    mean_temp = mean(mean_temp),
    O2 = mean(O2),
    depth = mean(mean_depth),
    pct = mean(pct),
    pres = sum(pres),
    n = sum(n),
            .groups = "drop") 

meanplot %>%
  ggplot(aes(y = mean_temp, x = depth,
             color = O2)) + 
  geom_point(size = 5) +
  geom_point(data = filter(meanplot, pct>0.35),
             aes(y = mean_temp, x = depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  scale_color_viridis_c(option = "inferno")

meanplot %>%
  ggplot(aes(y = O2, x = depth,
             color = mean_temp)) + 
  geom_point(size = 5) +
  geom_point(data = filter(meanplot, pct>0.5),
             aes(y = O2, x = depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  scale_color_viridis_c(option = "inferno")

dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_depth, y = O2,
             color = mean_temp)) + 
  geom_point(size = 3, alpha = .7) +
  geom_point(data = filter(dat_train_dens80_occ, (pres/n)>0.8),
             aes(y = O2, x = mean_depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  scale_color_viridis_c(option = "inferno") +
  theme_bw()

dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_depth, y = mean_tempL1,
             color = O2L1)) + 
  geom_point(size = 4, alpha = .5) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(pres/n)>=0.8),
             aes(y = mean_temp, x = mean_depth),
             color = "black", fill = "red", size = 2, shape = 21) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(presb/n)>=0.8),
             aes(y = mean_temp, x = mean_depth),
             color = "black", fill = "black", size = 1, shape = 21) +
  labs(x = "Mean depth (m)", 
       y = "Mean bottom temperature (C)",
       color = "O2") +
  scale_color_viridis_c(option = "inferno") +
  theme_bw()

ggsave("figures/dynocc/scal_pres_v_temp_O2_L1.png", 
       height = 4, width = 6, dpi = 400)

dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_tempL1, y = O2L1,
             color = mean_depth)) + 
  geom_point(size = 4, alpha = .5) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(pres/n)>=0.8),
             aes(y = O2, x = mean_temp),
             color = "black", fill = "red", size = 2, shape = 21) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(presb/n)>=0.8),
             aes(y = O2, x = mean_temp),
             color = "black", fill = "black", size = 1, shape = 21) +
  labs(x = "Mean bottom temperature (C)", 
       y = "Oxygen concentration",
       color = "Depth (m)") +
  scale_color_viridis_c(option = "inferno") +
  theme_bw()

ggsave("figures/dynocc/scal_pres_v_temp_O2b_L1.png", 
       height = 4, width = 6, dpi = 400)

dat_train_dens80_occ %>% 
  filter(n>=5) %>% 
  ggplot(aes(x = mean_temp, y = O2,
             color = strat)) + 
  geom_point(size = 4, alpha = .5) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(pres/n)>=0.8),
             aes(y = O2, x = mean_temp),
             color = "black", fill = "red", size = 2, shape = 21) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(presb/n)>=0.8),
             aes(y = O2, x = mean_temp),
             color = "black", fill = "black", size = 1, shape = 21) +
  labs(x = "Mean bottom temperature (C)", 
       y = "Oxygen concentration",
       color = "Stratification") +
  scale_color_viridis_c(option = "inferno") +
  theme_bw()

ggsave("figures/dynocc/scal_pres_v_temp_O2_strat.png", 
       height = 4, width = 6, dpi = 400)
```
# Define the model (psi.sbt.o2.strat, phi.sbt.o2.strat, gam.sbt.o2.strat)
```{r}

cat(file = "scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt", 
    "
model{
  for(i in 1:nSites) {
    # biological process
    lpsi1[i] <- lpsiInt + betapsiO2*O2a[i,1] + betapsistrat*strat[i,1]
    psi1[i] <- ilogit(lpsi1[i])*exp(-0.5*((climvar1[i,1]-Topt1)/width1)^2)
    z[i, 1] ~ dbern(psi1[i])
    for(t in 2:nYears) {
      lphi[i, t-1] <- lphiInt[t-1] + betaphiO2*O2b[i,t-1] +
                        betaphistrat*strat[i,t-1]
      phi[i, t-1] <-
        ilogit(lphi[i,t-1])*exp(-0.5*((climvar2[i,t-1]-Topt2)/width2)^2)
      lgam[i, t-1] <- lgamInt[t-1] + betagamO2*O2c[i,t-1] +
                        betagamstrat*strat[i,t-1]
      gamma[i, t-1] <- 
        ilogit(lgam[i, t-1])*exp(-0.5*((climvar3[i,t-1]-Topt3)/width3)^2)
      z[i, t] ~ dbern(z[i, t-1]*phi[i, t-1] +
          (1 - z[i, t-1])*gamma[i, t-1])
   }
    # detection process
    for(t in 1:nYears) {
      y[i, t] ~ dbin(p[t] * z[i, t], n[i, t])
    # log.lik[i,t]  <- logdensity.bin(y[i,t],p[i,t],1) # for lppd
    }
    
    
  }

  # Priors
  psiInt ~ dbeta(1, 1)
  lpsiInt <- logit(psiInt)

  for(t in 1:(nYears-1)) {
    phiInt[t] ~ dbeta(1, 1)
    lphiInt[t] <- logit(phiInt[t])
    gamInt[t] ~ dbeta(1, 1)
    lgamInt[t] <- logit(gamInt[t])
  }

  for(t in 1:nYears) {
    p[t] ~ dbeta(1, 1)
  }

  Topt1 ~ dnorm(8,16)
  width1 ~ dnorm(5,10)
  Topt2 ~ dnorm(8,16)
  width2 ~ dnorm(5,10)
  Topt3 ~ dnorm(8,16)
  width3 ~ dnorm(5,10)
  betapsiO2 ~ dnorm(0,5)
  betaphiO2 ~ dnorm(0,5)
  betagamO2 ~ dnorm(0,5)
  betapsistrat ~ dnorm(0,5)
  betaphistrat ~ dnorm(0,5)
  betagamstrat ~ dnorm(0,5)

  # Derived variable
  for(t in 1:nYears) {
    N[t] <- sum(z[,t]) # no. sites occupied for each year
  }
  
  # log.lik.cum[i] <- sum(log.lik[i,])
  
}
")
```
# Define the model (psi.sbt.o2.strat, phi.sbt.o2, gam.sbt.strat)
```{r}

cat(file = "scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.gam.sbt.strat.txt", 
    "
model{
  for(i in 1:nSites) {
    # biological process
    lpsi1[i] <- lpsiInt + betapsiO2*O2a[i,1] + betapsistrat*strat[i,1]
    psi1[i] <- ilogit(lpsi1[i])*exp(-0.5*((climvar1[i,1]-Topt1)/width1)^2)
    z[i, 1] ~ dbern(psi1[i])
    for(t in 2:nYears) {
      lphi[i, t-1] <- lphiInt[t-1] + betaphiO2*O2b[i,t-1]
      phi[i, t-1] <-
        ilogit(lphi[i,t-1])*exp(-0.5*((climvar2[i,t-1]-Topt2)/width2)^2)
      lgam[i, t-1] <- lgamInt[t-1] + 
                        betagamstrat*strat[i,t-1]
      gamma[i, t-1] <- 
        ilogit(lgam[i, t-1])*exp(-0.5*((climvar3[i,t-1]-Topt3)/width3)^2)
      z[i, t] ~ dbern(z[i, t-1]*phi[i, t-1] +
          (1 - z[i, t-1])*gamma[i, t-1])
   }
    # detection process
    for(t in 1:nYears) {
      y[i, t] ~ dbin(p[t] * z[i, t], n[i, t])
    # log.lik[i,t]  <- logdensity.bin(y[i,t],p[i,t],1) # for lppd
    }
    
    
  }

  # Priors
  psiInt ~ dbeta(1, 1)
  lpsiInt <- logit(psiInt)

  for(t in 1:(nYears-1)) {
    phiInt[t] ~ dbeta(1, 1)
    lphiInt[t] <- logit(phiInt[t])
    gamInt[t] ~ dbeta(1, 1)
    lgamInt[t] <- logit(gamInt[t])
  }

  for(t in 1:nYears) {
    p[t] ~ dbeta(1, 1)
  }

  Topt1 ~ dnorm(8,16)
  width1 ~ dnorm(5,10)
  Topt2 ~ dnorm(8,16)
  width2 ~ dnorm(5,10)
  Topt3 ~ dnorm(8,16)
  width3 ~ dnorm(5,10)
  betapsiO2 ~ dnorm(0,5)
  betaphiO2 ~ dnorm(0,5)
  # betagamO2 ~ dnorm(0,5)
  betapsistrat ~ dnorm(0,5)
  # betaphistrat ~ dnorm(0,5)
  betagamstrat ~ dnorm(0,5)

  # Derived variable
  for(t in 1:nYears) {
    N[t] <- sum(z[,t]) # no. sites occupied for each year
  }
  
  # log.lik.cum[i] <- sum(log.lik[i,])
  
}
")
```
# Define the model (psi.sbt.o2, phi.sbt.o2, gam.sbt.o2)
```{r}

cat(file = "scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt", 
    "
model{
  for(i in 1:nSites) {
    # biological process
    lpsi1[i] <- lpsiInt + betapsiO2*O2a[i,1]
    psi1[i] <- ilogit(lpsi1[i])*exp(-0.5*((climvar1[i,1]-Topt1)/width1)^2)
    z[i, 1] ~ dbern(psi1[i])
    for(t in 2:nYears) {
      lphi[i, t-1] <- lphiInt[t-1] + betaphiO2*O2b[i,t-1]
      phi[i, t-1] <-
        ilogit(lphi[i,t-1])*exp(-0.5*((climvar2[i,t-1]-Topt2)/width2)^2)
      lgam[i, t-1] <- lgamInt[t-1] + 
                        betagamO2*O2c[i,t-1]
      gamma[i, t-1] <- 
        ilogit(lgam[i, t-1])*exp(-0.5*((climvar3[i,t-1]-Topt3)/width3)^2)
      z[i, t] ~ dbern(z[i, t-1]*phi[i, t-1] +
          (1 - z[i, t-1])*gamma[i, t-1])
   }
    # detection process
    for(t in 1:nYears) {
      y[i, t] ~ dbin(p[t] * z[i, t], n[i, t])
    # log.lik[i,t]  <- logdensity.bin(y[i,t],p[i,t],1) # for lppd
    }
    
    
  }

  # Priors
  psiInt ~ dbeta(1, 1)
  lpsiInt <- logit(psiInt)

  for(t in 1:(nYears-1)) {
    phiInt[t] ~ dbeta(1, 1)
    lphiInt[t] <- logit(phiInt[t])
    gamInt[t] ~ dbeta(1, 1)
    lgamInt[t] <- logit(gamInt[t])
  }

  for(t in 1:nYears) {
    p[t] ~ dbeta(1, 1)
  }

  Topt1 ~ dnorm(8,16)
  width1 ~ dnorm(5,10)
  Topt2 ~ dnorm(8,16)
  width2 ~ dnorm(5,10)
  Topt3 ~ dnorm(8,16)
  width3 ~ dnorm(5,10)
  betapsiO2 ~ dnorm(0,5)
  betaphiO2 ~ dnorm(0,5)
  betagamO2 ~ dnorm(0,5)

  # Derived variable
  for(t in 1:nYears) {
    N[t] <- sum(z[,t]) # no. sites occupied for each year
  }
  
  # log.lik.cum[i] <- sum(log.lik[i,])
  
}
")
```
# Bundle data for JAGS & run models (mean SBT only)
# model: psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2
# Mean, mean, mean SBT hypothesis
# LAG 0 for Persistence; LAGS 0-3 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)
strat_matS <- wiqid::standardize(strat_mat)

jdata_L0mean <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbt_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS,
    strat = strat_matS)
str(jdata_L0mean)

jdataL0L1a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS,
    strat = strat_matS)
str(jdataL0L1a)

jdataL0L2a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L2_matS,
    strat = strat_matS)
str(jdataL0L2a)

jdataL0L3a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L3_matS,
    strat = strat_matS)
str(jdataL0L3a)

wanted <- c("Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", 
            "betapsiO2", "betaphiO2", "betagamO2",
            "betapsistrat", "betaphistrat", "betagamstrat",
            "N", "gamma", "phi",
            "psiInt", "phiInt", "gamInt", "p")

# psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2
( psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2 <- 
    jagsUI::jags(jdata_L0mean, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2 <- 
    jagsUI::jags(jdataL0L1a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2 <- 
    jagsUI::jags(jdataL0L2a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2 <- 
    jagsUI::jags(jdataL0L3a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.rds")
```

# Bundle data for JAGS & run models
# Mean, Max, Min SBT hypothesis
# LAG 0 for Persistence; LAGS 0-3 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)
strat_matS <- wiqid::standardize(strat_mat)

jdata <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbt_mat, z = z, depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS,
    strat = strat_matS)
str(jdata)

jdataL0L1 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS,
    strat = strat_matS)
str(jdataL0L1)

jdataL0L2 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L2_matS,
    strat = strat_matS)
str(jdataL0L2)

jdataL0L3 <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = minsbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L3_matS,
    strat = strat_matS)
str(jdataL0L3)

wanted <- c("Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", 
            "betapsiO2", "betaphiO2", "betagamO2",
            "betapsistrat", "betaphistrat", "betagamstrat",
            "N", "gamma", "phi",
            "lgamInt", "phiInt", "gamInt", "p")

# lag 0 for all variables
# psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2
( psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2 <- 
    jagsUI::jags(jdata, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )
# original runs were 10000 iter + 1000 adapt (300 MB file)
# looic runs are 1

saveRDS(psi.meansbt.o2.phi.maxsbt.o2.gam.minsbt.o2,
        "output/psi.meansbt.o2.strat.phi.maxsbt.o2.strat.gam.minsbt.o2.strat.rds")

# psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2
( psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2 <- 
    jagsUI::jags(jdataL0L1, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL1.o2,
        "output/psi.meansbt.o2.strat.phi.maxsbtL0.o2.strat.gam.minsbtL1.o2.strat.rds")

# psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2
( psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2 <- 
    jagsUI::jags(jdataL0L2, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL2.o2,
        "output/psi.meansbt.o2.strat.phi.maxsbtL0.o2.strat.gam.minsbtL2.o2.strat.rds")

# psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2
( psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2 <- 
    jagsUI::jags(jdataL0L3, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.maxsbtL0.o2.gam.minsbtL3.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.maxsbtL0.o2.strat.gam.minsbtL3.o2.strat.rds")
```
# Bundle data for JAGS & run models (mean SBT only)
# Mean, mean, mean SBT hypothesis
# LAG 0 for Persistence; LAGS 0-3 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)
strat_matS <- wiqid::standardize(strat_mat)

jdata_L0mean <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbt_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS,
    strat = strat_matS)
str(jdata_L0mean)

jdataL0L1a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS,
    strat = strat_matS)
str(jdataL0L1a)

jdataL0L2a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L2_matS,
    strat = strat_matS)
str(jdataL0L2a)

jdataL0L3a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L3_matS,
    strat = strat_matS)
str(jdataL0L3a)

wanted <- c("Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", 
            "betapsiO2", "betaphiO2", "betagamO2",
            "betapsistrat", "betaphistrat", "betagamstrat",
            "N", "gamma", "phi",
            "psiInt", "phiInt", "gamInt", "p")

# psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2
( psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2 <- 
    jagsUI::jags(jdata_L0mean, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.strat.gam.meansbt.o2.strat.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2 <- 
    jagsUI::jags(jdataL0L1a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbtL0.o2.strat.gam.meansbtL1.o2.strat.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2 <- 
    jagsUI::jags(jdataL0L2a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbtL0.o2.strat.gam.meansbtL2.o2.strat.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2 <- 
    jagsUI::jags(jdataL0L3a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.strat.gam.sbt.o2.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbtL0.o2.strat.gam.meansbtL3.o2.strat.rds")
```
# SMALLER MODELS W/ JUST 1 LINEAR COVARIATE EACH
# Bundle data for JAGS & run models (mean SBT only)
# Mean, mean, mean SBT hypothesis
# LAG 0 for Persistence; LAGS 0-3 for Colonization
```{r}
# Get known values of z
z <- (ymat > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)
strat_matS <- wiqid::standardize(strat_mat)

jdata_L0mean <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbt_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS,
    strat = strat_matS)
str(jdata_L0mean)

jdataL0L1a <- list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS,
    strat = strat_matS)
str(jdataL0L1a)

jdata_L0meanmax <- 
  list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymat,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = maxsbt_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS,
    strat = strat_matS)
str(jdata_L0meanmax)

wanted <- c("Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", 
            "betapsiO2", "betaphiO2", 
            "betapsistrat", "betagamstrat",
            "N", "gamma", "phi",
            "psiInt", "phiInt", "gamInt", "p")

# psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat
( psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat <- 
    jagsUI::jags(jdata_L0mean, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.gam.sbt.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat.rds")

# psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat
( psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbtL1.strat <- 
    jagsUI::jags(jdataL0L1a, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.gam.sbt.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbtL1.strat,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbtL1.strat.rds")

# psi.meansbt.o2.strat.phi.maxsbt.o2.gam.meansbt.strat
( psi.meansbt.o2.strat.phi.maxsbt.o2.gam.meansbt.strat <- 
    jagsUI::jags(jdata_L0meanmax, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.strat.phi.sbt.o2.gam.sbt.strat.txt",
                      n.thin = 30,
    n.chains=3, n.iter=90000, n.adapt=10000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.strat.phi.maxsbt.o2.gam.meansbt.strat,
        "D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.maxsbt.o2.gam.meansbt.strat.rds")
```

# Bonanza model (90th percentile hauls): 
# Bundle data for JAGS & run models (mean SBT only)
# Mean, mean, mean SBT hypothesis
# LAG 0 for Persistence; LAGS 0-3 for Colonization
```{r}
# Get known values of z
z <- (ymatb > 0)*1
z[z == 0] <- NA

# Standardize covariates
o2_matS <- wiqid::standardize(O2_mat)
o2L1_matS <- wiqid::standardize(O2L1_mat)
o2L2_matS <- wiqid::standardize(O2L2_mat)
o2L3_matS <- wiqid::standardize(O2L3_mat)
depth_matS <- wiqid::standardize(depth_mat)

jdata_L0mean.b <- 
  list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymatb,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbt_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2_matS)
str(jdata_L0mean.b)

jdataL0L1a.b <- 
  list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymatb,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL1_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L1_matS)
str(jdataL0L1a.b)

jdataL0L2a.b <- 
  list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymatb,
    n = nmat, climvar1 = meansbt_mat, climvar2 = maxsbt_mat, 
    climvar3 = meansbtL2_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L2_matS)
str(jdataL0L2.b)

jdataL0L3a.b <- 
  list(nSites = nrow(ymat), nYears = ncol(ymat), y = ymatb,
    n = nmat, climvar1 = meansbt_mat, climvar2 = meansbt_mat, 
    climvar3 = meansbtL3_mat, z = z,  depth = depth_matS,
    O2a = o2_matS, O2b = o2_matS, O2c = o2L3_matS)
str(jdataL0L3a.b)

wanted <- c("psiInt", "phiInt", "gamInt", "p", "Topt1", "width1", 
            "Topt2", "width2", "Topt3", "width3", "N", "gamma", "phi",
            "betapsiO2", "betaphiO2", "betagamO2")

# psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.b
( psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.b <- 
    jagsUI::jags(jdata_L0mean.b, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.b,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbt.o2.gam.meansbt.o2.b.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b <- 
    jagsUI::jags(jdataL0L1a.b, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b_90pct.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.b
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.b <- 
    jagsUI::jags(jdataL0L2a.b, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.b,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL2.o2.b.rds")

# psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.b
( psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.b <- 
    jagsUI::jags(jdataL0L3a.b, NULL, wanted, 
"scripts/scal_dyn_occ_psi.sbt.o2.phi.sbt.o2.gam.sbt.o2.txt",
                      n.thin = 10,
    n.chains=3, n.iter=10000, n.adapt=1000, DIC=T, parallel=TRUE) )

saveRDS(psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.b,
        "D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL3.o2.b.rds")
```
# Check model output
```{r}

mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat.rds")
mod$mean$Topt1
mod$mean$width1
mod$mean$Topt2
mod$mean$width2
mod$mean$Topt3
mod$mean$width3
mod$mean$betapsiO2
mod$q2.5$betapsiO2
mod$q97.5$betapsiO2
mod$mean$betaphiO2
mod$q2.5$betaphiO2
mod$q97.5$betaphiO2
mod$mean$betagamO2
mod$q2.5$betagamO2
mod$q97.5$betagamO2
mod$mean$betapsistrat
mod$q2.5$betapsistrat
mod$q97.5$betapsistrat
mod$mean$betaphistrat
mod$q2.5$betaphistrat
mod$q97.5$betaphistrat
mod$mean$betagamstrat
mod$q2.5$betagamstrat
mod$q97.5$betagamstrat


```
# Map mean colonization - extinction by patch
Model: psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat
```{r}
mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  mod$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-mod$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p
rm(col.p, ext.p)

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q95.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.95))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q95 = colext.q95.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map modelled mean col-ext for 1983-2014
(colext_map <- colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "+") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q95<0),
               shape = "-") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))
)

ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/scallop_dynocc_predicted_colext_rmeanstrat_mmaxO2.png",
        height = 5, width = 5, dpi = 400)
```
# plot col-ext - bivariate surface vs SBT and O2
model: psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat
```{r}
mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat.rds")

# find a typical value for phi intercept
mod$mean$phiInt
median(mod$mean$phiInt) # 0.9091696
# median phi annual intercept

# find a typical value for gam intercept
mod$mean$gamInt
median(mod$mean$gamInt) # 0.2270931
# year 15 is median phi annual intercept; year 23 is close

O2pred <- seq(min(dat_train_dens80_occ$O2), 
              max(dat_train_dens80_occ$O2),
              length.out = 100)
O2predS <- wiqid::standardize2match(O2pred, O2_mat)

stratpred <- seq(min(dat_train_dens80_occ$strat), 
              max(dat_train_dens80_occ$strat),
              length.out = 100)
stratpredS <- wiqid::standardize2match(stratpred, strat_mat)

meanSBTpred <- seq(min(dat_train_dens80_occ$mean_temp), 
              max(dat_train_dens80_occ$mean_temp),
              length.out = 100)

phipred <- matrix(NA, nrow = 100, ncol = 100)
for(o in 1:100){
  for(s in 1:100){
phipred[o,s] <- plogis(
  qlogis(median(mod$mean$phiInt)) + 
    (mod$mean$betaphiO2 * O2predS[o])
) * exp(-0.5*((meanSBTpred[s]-mod$mean$Topt2)/mod$mean$width2)^2)
}
}

gampred <- matrix(NA, nrow = 100, ncol = 100)
for(o in 1:100){
  for(s in 1:100){
gampred[o,s] <- plogis(
  qlogis(median(mod$mean$gamInt)) + 
    (mod$mean$betagamstrat * stratpredS[o])
) * exp(-0.5*((meanSBTpred[s]-mod$mean$Topt3)/mod$mean$width3)^2)
}
}

gam.mat.df <- gampred %>%
  as.data.frame() %>%
  mutate(strat = stratpred) %>%
  pivot_longer(cols = 1:100, values_to = "gamma") %>%
  mutate(mean_temp = rep(meanSBTpred, 100))

phi.mat.df <- phipred %>%
  as.data.frame() %>%
  mutate(O2 = O2pred) %>%
  pivot_longer(cols = 1:100, values_to = "phi") %>%
  mutate(mean_temp = rep(meanSBTpred, 100))

# find cells/years with lots of 80mm+ scallops
quantile(dat_dens80[dat_dens80$mean_dens>0,]$mean_dens, 
         0.99, na.rm = T) # 586.1
quantile(dat_dens80[dat_dens80$mean_dens>0,]$mean_dens, 
         0.95, na.rm = T) # 161.8
quantile(dat_dens80[dat_dens80$mean_dens>0,]$mean_dens, 
         0.05, na.rm = T) # 0.1963636

(col_biv <- gam.mat.df %>%
  ggplot() +
  geom_tile(aes(x = mean_temp,
                y = strat, fill = gamma)) +  
  geom_point(data = filter(dat_dens80, mean_dens == 0),
             aes(y = strat, x = climvar_rec),
             color = "darkgray", shape = 1, size = 0.5) + 
  geom_point(data = filter(dat_dens80, mean_dens > 0 & mean_dens <=0.1963636),
             aes(y = strat, x = climvar_rec),
             color = "darkgray", shape = 1, size = 2) +
  geom_point(data = filter(dat_dens80, mean_dens < 586.1 & mean_dens >161.8143),
             aes(y = strat, x = climvar_rec),
             color = "darkgray", 
             fill = "red",
             shape = 21, size = 2) +
  geom_point(data = filter(dat_dens80, mean_dens >= 586.1),
             aes(y = strat, x = climvar_rec),
             color = "darkgray",
             fill = "red",
             size = 4, shape = 21) +
  theme_bw() +
    theme(text = element_text(size = 12),
          axis.text = element_text(size = 10),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "Mean bottom temp. (C)", 
         y = "Stratification", 
         fill = "",
         title = "Colonization") + 
  scale_fill_viridis_c(option = "inferno")
)

saveRDS(col_biv,
          "figures/rmeanstrat_mmeanO2_h_dynocc/colonize_surface.rds")

ggsave(paste0("figures/rmeanstrat_mmeanO2_h_dynocc/",
              "col_bivariate_sbt_strat.png"), 
       height = 4, width = 6,
       dpi = 400)

# plot predicted "persistence" (phi) vs. O2 & mean SBT
(phi_biv <- phi.mat.df %>%
  ggplot() +
  geom_tile(aes(x = mean_temp,
                y = O2, fill = phi)) +  
  geom_point(data = filter(dat_dens80, mean_dens == 0),
             aes(y = O2, x = climvar_mort),
             color = "darkgray", shape = 1, size = 0.5) + 
  geom_point(data = filter(dat_dens80, mean_dens > 0 & mean_dens <=0.1963636),
             aes(y = O2, x = climvar_mort),
             color = "darkgray", shape = 1, size = 2) +
  geom_point(data = filter(dat_dens80, mean_dens < 586.1 & mean_dens >161.8143),
             aes(y = O2, x = climvar_mort),
             color = "darkgray", 
             fill = "red",
             shape = 21, size = 2) +
  geom_point(data = filter(dat_dens80, mean_dens >= 586.1),
             aes(y = O2, x = climvar_mort),
             color = "darkgray",
             fill = "red",
             size = 4, shape = 21) +
  theme_bw() +
    theme(text = element_text(size = 12),
          axis.text = element_text(size = 10),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "Mean bottom temp. (C)", 
         y = "Oxygen concentration", 
         fill = "",
         title = "Persistence") + 
  scale_fill_viridis_c(option = "inferno")
)

saveRDS(phi_biv,
          "figures/rmeanstrat_mmeanO2_h_dynocc/persist_surface.rds")
  
ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/phi_bivariate_sbt_O2.png", 
       height = 4, width = 6,
       dpi = 400)

library(patchwork)
col_biv + phi_biv + colext_map + plot_layout(ncol = 3, 
                                             widths = 5, heights = 5)
ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/col_phi_colextmap.png",
       height = 3, width = 12, dpi = 400)

(colext_map / (col_biv + phi_biv)) + plot_layout(widths = 5, 
                                                 heights = 5)
ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/col_phi_colextmap2.png",
       height = 6, width = 8, dpi = 400)

```
# plot predicted N over time
```{r}
plot(mod$mean$N, 
     type = "l")

N.plot <- data.frame(
  year = 1983:2014,
  N = mod$mean$N,
  q2.5 = mod$q2.5$N,
  q97.5 = mod$q97.5$N,
  q10 = apply(
    mod$sims.list$N, 2,
    function(x)quantile(x, 0.1)),
  q90 = apply(
    mod$sims.list$N, 2,
    function(x)quantile(x, 0.9)),
  type = "80mm+") # %>%
  # bind_rows(
  #   data.frame(
  # N = psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$N,
  # year = 1983:2014,
  # q2.5 = psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q2.5$N,
  # q97.5 = psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$q97.5$N,
  # q10 = apply(
  #   psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$sims.list$N, 2,
  #   function(x)quantile(x, 0.1)),
  # q90 = apply(
  #   psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$sims.list$N, 2,
  #   function(x)quantile(x, 0.9)),
  # type = "Any 80mm+")
# )

gam.plot <- apply(apply(mod$sims.list$gamma, c(1,3), mean), 2, 
      function(x)quantile(x, c(0.025, .1, 0.5, .9, 0.975))) %>%
  t() %>%
  as.data.frame() %>%
  rename(q2.5 = 1, q10 = 2, col = 3, 
         q90 = 4, q97.5 = 5) %>%
  mutate(year = 1983:2013,
         type = "80mm+")

phi.plot <- apply(apply(mod$sims.list$phi, c(1,3), mean), 2, 
      function(x)quantile(x, c(0.025, .1, 0.5, .9, 0.975))) %>%
  t() %>%
  as.data.frame() %>%
  rename(q2.5 = 1, q10 = 2, phi = 3, 
         q90 = 4, q97.5 = 5) %>%
  mutate(year = 1983:2013,
         type = "80mm+")

# plot N over time
(np <- N.plot %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = q2.5, ymax = q97.5),
              alpha = 0.25) +
  geom_ribbon(aes(x = year, ymin = q10, ymax = q90),
              alpha = 0.25) +
  geom_line(aes(x = year, y = N),
            size = 1) +
  scale_color_manual(values = c("firebrick", "steelblue")) +
  scale_fill_manual(values = c("firebrick", "steelblue")) +
  labs(fill = "", color = "",
       y = "No. occupied cells (out of 116)",
       x = "") +
  theme_bw()
)

ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/N_occ_patches_over_time.png",
       height = 4, width = 5, dpi = 400)

# plot mean colonization rate over time
(gp <- gam.plot %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = q2.5, ymax = q97.5),
              alpha = 0.25) +
  geom_ribbon(aes(x = year, ymin = q10, ymax = q90),
              alpha = 0.25) +
  geom_line(aes(x = year, y = col),
            size = 1) +
  scale_color_manual(values = c("firebrick", "steelblue")) +
  scale_fill_manual(values = c("firebrick", "steelblue")) +
  labs(fill = "", color = "",
       y = "Colonization rate",
       x = "") +
  theme_bw()
)

ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/Mean_col_over_time.png",
       height = 4, width = 5, dpi = 400)

# plot mean persistence rate over time
(pp <- phi.plot %>%
  ggplot() +
  geom_ribbon(aes(x = year, ymin = 1-q2.5, ymax = 1-q97.5),
              alpha = 0.25) +
  geom_ribbon(aes(x = year, ymin = 1-q10, ymax = 1-q90),
              alpha = 0.25) +
  geom_line(aes(x = year, y = 1-phi),
            size = 1) +
  scale_color_manual(values = c("firebrick", "steelblue")) +
  scale_fill_manual(values = c("firebrick", "steelblue")) +
  labs(fill = "", color = "",
       y = "Extinction rate",
       x = "") +
  theme_bw()
)

ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/Mean_ext_over_time.png",
       height = 4, width = 5, dpi = 400)

library(patchwork)
np/pp/gp
ggsave("figures/rmeanstrat_mmeanO2_h_dynocc/N_gam_phi.png",
       height = 9, width = 4, dpi = 400)

```










# Mapping mean Colonization - Extinction (test period)
```{r}
out <- readRDS("output/out_meansbt_gaus4.rds")

colext_mat <- apply(out$sims.list$colminusext_proj, c(2,3), median)
colext_mean <- apply(colext_mat, 1, mean) %>%
  as.data.frame() %>%
  rename(colext = 1) %>%
  mutate(grid = unique(dat_train_dens80_occ$grid)) %>%
  mutate(grid_lat = as.numeric(substr(grid, 1, 4)),
         grid_lon = as.numeric(substr(grid, 5, 9)),
         lat = grid_lat,
         lon = grid_lon) %>%
  sf::st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext_mean)

ggplot() +
  geom_tile(aes(x = lon, y = lat, fill = colext),
            # alpha = 1,
            data = colext_mean,
            color = "black") +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8)) +
  labs(x = "", y = "", fill = "Mean predicted\ncolonization - extinction rate\n(2005-2014)",
       title = "Dynamic occupancy model\n(based on mean SBT)") + 
  scale_fill_gradient2(midpoint = 0, 
                       low = "steelblue", 
                       mid = "white",
                       high = "firebrick", space = "Lab") +
  theme(text = element_text(size = 14),
        title = element_text(size = 12))

ggsave("figures/dynocc/projected_colext.png", 
       height = 6, width = 6, dpi = 400)
```



# Map col-ext for training set for model with and without O2
```{r}
out_meansbt_gaus <- readRDS("output/out_meansbt_gaus4.rds")
out_meansbt_gausO2 <- readRDS("output/out_meansbt_gaus_O2.rds")
params_gaus <- out_meansbt_gaus$mean
params_gausO2 <- out_meansbt_gausO2$mean

colext_gaus <- params_gaus$gamma-(1-params_gaus$phi) %>%
  apply(.,1,mean) %>%
  as.data.frame() %>%
  rename(colext = 1)
```

# Mapping change in psi over time
```{r}
# http://www.seec.uct.ac.za/dynamic-occupancy-models
# We estimated occupancy in the first year, \(\Psi_1\). But what about occupancy probabilities in subsequent years? They are derived parameters, calculated as \(\Psi_t = \Psi_{t-1} \times (1-\epsilon_{t-1}) + (1-\Psi_{t-1}) \times \gamma_{t-1}\).

psix <- params$psiInt*(exp(-0.5*((meansbt_mat[,1]-params$Topt1)/params$width1)^2))
phix <- plogis(lphix)*(exp(-0.5*((cx-params$Topt2)/params$width2)^2))
gamx <- plogis(lgamx)*(exp(-0.5*((cx-params$Topt3)/params$width3)^2))
```
# map scallop abundance (1983-1997) & (1999-2014)
```{r}

obs80_rmean_train1 <- dat_train_dens80 %>%
  arrange(patch, year) %>%
  mutate(year = year + 1979,
         obs80 = mean_dens) %>%
  filter(year %in% 1983:1998) %>%
  group_by(grid) %>%
  summarize(mean_dens = mean(mean_dens, na.rm = T)) %>%
  mutate(grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

obs80_rmean_train2 <- dat_train_dens80 %>%
  arrange(patch, year) %>%
  mutate(year = year + 1979,
         obs80 = mean_dens) %>%
  filter(year %in% 1999:2014) %>%
  group_by(grid) %>%
  summarize(mean_dens = mean(mean_dens, na.rm = T)) %>%
  mutate(grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

# map observed density, 1983-1998  
ggplot() +
  geom_tile(aes(x = lon, y = lat, fill = mean_dens),
            data = obs80_rmean_train1,
            color = "black") +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8)) +
  viridis::scale_color_viridis(option = "inferno") +
  labs(x = "", y = "", fill = "Mean n\nper tow\n(80mm+)",
       title = "Observed density, 1983-1998") + 
  scale_fill_viridis_c(option = "inferno",
                       limits = c(0,520)) +
  theme(text = element_text(size = 14),
        title = element_text(size = 12)) 

ggsave("figures/dynocc/obsdens80_1983_1998.png", 
       height = 6, width = 6, dpi = 400)

# map observed density, 1999-2014  
ggplot() +
  geom_tile(aes(x = lon, y = lat, fill = mean_dens),
            data = obs80_rmean_train2,
            color = "black") +
  geom_sf(data = state_bounds, aes(), color = "gray",
          size = .25) +  theme_bw() +
  theme(text = element_text(size = 15),
        axis.text = element_text(size = 6),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8)) +
  viridis::scale_color_viridis(option = "inferno") +
  labs(x = "", y = "", fill = "Mean n\nper tow\n(80mm+)",
       title = "Observed density, 1999-2014") + 
  scale_fill_viridis_c(option = "inferno",
                       limits = c(0,520)) +
  theme(text = element_text(size = 14),
        title = element_text(size = 12)) 

ggsave("figures/dynocc/obsdens80_1999_2014.png", 
       height = 6, width = 6, dpi = 400)
```






















# Map mean colonization - extinction by patch
Model: psi.meansbt.o2.strat.phi.maxsbt.o2.gam.meansbt.strat
```{r}
mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.maxsbt.o2.gam.meansbt.strat.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  mod$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-mod$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p

# to check that apply worked right
# colext.m <- psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$gamma - (1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$phi)

# get mean & q2.5 of posterior for col - ext by cell and year
# colext.mean.by.year = apply(colext.p, c(2,3), mean)
# colext.q2.5.by.year = apply(colext.p, c(2,3), function(x)quantile(x, 0.025))

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q95.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.95))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q95 = colext.q95.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map modelled mean col-ext for 1983-2014
colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "+") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q95<0),
               shape = "-") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction\n(1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))

ggsave("figures/dynocc/scallop_dynocc_predicted_colext_rmeanstrat_mmaxO2.png",
        height = 5, width = 5, dpi = 400)
```

# Map mean colonization - extinction by patch
Model: psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2
```{r}
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2 <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p

# to check that apply worked right
# colext.m <- psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$gamma - (1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$phi)

# get mean & q2.5 of posterior for col - ext by cell and year
# colext.mean.by.year = apply(colext.p, c(2,3), mean)
# colext.q2.5.by.year = apply(colext.p, c(2,3), function(x)quantile(x, 0.025))

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q95.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.95))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q95 = colext.q95.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map modelled mean col-ext for 1983-2014
colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "+") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q95<0),
               shape = "-") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction\n(1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))

ggsave("figures/dynocc/scallop_dynocc_predicted_colext.png",
        height = 5, width = 5, dpi = 400)
```
# Map mean colonization - extinction by patch
Model: psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat
```{r}
mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  mod$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-mod$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p

# to check that apply worked right
# colext.m <- mod$mean$gamma - (1-mod$mean$phi)

# get mean & q2.5 of posterior for col - ext by cell and year
# colext.mean.by.year = apply(colext.p, c(2,3), mean)
# colext.q2.5.by.year = apply(colext.p, c(2,3), function(x)quantile(x, 0.025))

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q95.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.95))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q95 = colext.q95.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map modeled mean col-ext for 1983-2014
colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "+") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q95<0),
               shape = "-") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction\n(1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))

ggsave("figures/dynocc/scallop_dynocc_predicted_colext_rmeanstrat_mmeanO2.png",
        height = 5, width = 5, dpi = 400)
```
# Map mean colonization - extinction by patch
Model: psi.meansbt.o2.strat.phi.meansbtL0.o2.strat.gam.meansbt.o2.strat
```{r}
mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.strat.gam.meansbt.o2.strat.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  mod$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-mod$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p

# to check that apply worked right
# colext.m <- mod$mean$gamma - (1-mod$mean$phi)

# get mean & q2.5 of posterior for col - ext by cell and year
# colext.mean.by.year = apply(colext.p, c(2,3), mean)
# colext.q2.5.by.year = apply(colext.p, c(2,3), function(x)quantile(x, 0.025))

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q95.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.95))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q95 = colext.q95.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map modeled mean col-ext for 1983-2014
colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "+") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q95<0),
               shape = "-") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction\n(1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))

ggsave("figures/dynocc/scallop_dynocc_predicted_colext_rmeanO2strat_mmeanO2strat.png",
        height = 5, width = 5, dpi = 400)
```
# Bonanza (top 90% or 95%) model: Map mean colonization - extinction by patch
```{r}
psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b.rds")

# get posteriors for colonization (by cell and year)
col.p <- 
  psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b$sims.list$gamma

# get posteriors for extinction (by cell and year)
ext.p <-
  1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2.b$sims.list$phi

# get posteriors for col - ext (by cell and year)
colext.p <- col.p - ext.p

# to check that apply worked right
# colext.m <- psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$gamma - (1-psi.meansbt.o2.phi.meansbtL0.o2.gam.meansbtL1.o2$mean$phi)

# get mean & q2.5 of posterior for col - ext by cell and year
# colext.mean.by.year = apply(colext.p, c(2,3), mean)
# colext.q2.5.by.year = apply(colext.p, c(2,3), function(x)quantile(x, 0.025))

# get mean & LL of posterior for mean col - ext by cell (across years)
colext.mean.all.years = apply(apply(colext.p, c(1,2), mean), 2, mean)
colext.q5.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.05))
colext.q95.all.years = apply(apply(colext.p, c(1,2), mean), 2, 
                            function(x)quantile(x, 0.95))

# put mean col-ext by cell (across years) into a dataframe for mapping
colext <- ymat_gridnames %>%
  mutate(colext.mean = colext.mean.all.years,
         colext.q5 = colext.q5.all.years,
         colext.q95 = colext.q95.all.years,
         grid_lat = as.numeric(substr(grid, 1,5)),
         grid_lon = as.numeric(substr(grid, 6,11)),
         lat = grid_lat,
         lon = grid_lon) %>%
  st_as_sf(coords = c("grid_lon", "grid_lat"),
           crs = 4326)

state_bounds <- rnaturalearth::ne_coastline(scale = 10, returnclass = "sf") %>%
  st_crop(colext)

# map estimated change in scallop abundance per 1-2
colext %>%
    ggplot() +
    geom_tile(aes(x = lon, y = lat, fill = colext.mean),
              color = "black") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q5>0),
               shape = "+") +
    geom_point(aes(x = lon, y = lat),
               data = filter(colext, colext.q95<0),
               shape = "-", color = "black") +
    geom_sf(data = state_bounds, aes(), color = "gray",
            size = .25) +  theme_bw() +
    theme(text = element_text(size = 15),
          axis.text = element_text(size = 6),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "", y = "", fill = "",
         title = "Mean colonization - extinction\n(1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab") +
    theme(text = element_text(size = 14),
          title = element_text(size = 12, hjust = 0.5))

ggsave("figures/dynocc/scallop_dynocc_predicted_colext_95pct.png",
        height = 5, width = 5, dpi = 400)
```
# saving this here in case we do a model that allows bivariate colext plot
# plot col-ext - bivariate surface vs SBT and O2
model: psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat
```{r}
mod <- 
  readRDS("D:/scallop/dynocc_output/psi.meansbt.o2.strat.phi.meansbt.o2.gam.meansbt.strat.rds")

# find a typical value for phi intercept
mod$mean$phiInt
median(mod$mean$phiInt) # 0.9091696
# year 23 is median phi annual intercept

# find a typical value for gam intercept
mod$mean$gamInt
median(mod$mean$gamInt) # 0.2270931
# year 15 is median phi annual intercept; year 23 is close

O2pred <- seq(min(dat_train_dens80_occ$O2), 
              max(dat_train_dens80_occ$O2),
              length.out = 100)
O2predS <- wiqid::standardize2match(O2pred, O2_mat)

stratpred <- seq(min(dat_train_dens80_occ$strat), 
              max(dat_train_dens80_occ$strat),
              length.out = 100)
stratpredS <- wiqid::standardize2match(stratpred, strat_mat)

meanSBTpred <- seq(min(dat_train_dens80_occ$mean_temp), 
              max(dat_train_dens80_occ$mean_temp),
              length.out = 100)

phipred <- matrix(NA, nrow = 100, ncol = 100)
for(o in 1:100){
  for(s in 1:100){
phipred[o,s] <- plogis(
  qlogis(mod$mean$phiInt[23]) + 
    (mod$mean$betaphiO2 * O2predS[o])
) * exp(-0.5*((meanSBTpred[s]-mod$mean$Topt2)/mod$mean$width2)^2)
}
}

gampred <- matrix(NA, nrow = 100, ncol = 100)
for(o in 1:100){
  for(s in 1:100){
gampred[o,s] <- plogis(
  qlogis(mod$mean$gamInt[15]) + 
    (mod$mean$betagamstrat * stratpredS[o])
) * exp(-0.5*((meanSBTpred[s]-mod$mean$Topt3)/mod$mean$width3)^2)
}
}

colext.mat <- gampred - (1-phipred)

colext.mat.df <- colext.mat %>%
  as.data.frame() %>%
  mutate(O2 = O2pred) %>%
  pivot_longer(cols = 1:100, values_to = "colext") %>%
  mutate(mean_temp = rep(meanSBTpred, 100))

colext.mat.df %>%
  ggplot() +
  geom_tile(aes(x = mean_temp,
                y = O2, fill = colext)) +  
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(pres/n)>=0.8),
             aes(y = O2, x = mean_temp),
             color = "darkgray", 
             fill = "transparent", 
             size = 2, shape = 21) +
  geom_point(data = filter(dat_train_dens80_occ, n>=5,(presb/n)>=0.8),
             aes(y = O2, x = mean_temp),
             color = "darkgray", 
             fill = "red", 
             size = 2, shape = 21) +
  theme_bw() +
    theme(text = element_text(size = 12),
          axis.text = element_text(size = 10),
          legend.title = element_text(size = 8),
          legend.text = element_text(size = 8)) +
    labs(x = "Mean bottom temp. (C)", 
         y = "Oxygen concentration", 
         fill = "",
         title = "Colonization rate - extinction rate\nfor a typical year (1983-2014)") + 
    scale_fill_gradient2(midpoint = 0,
                         low = "steelblue",
                         mid = "white",
                         high = "firebrick", space = "Lab")

ggsave("figures/dynocc/colext_bivariate_sbt_o2.png", 
       height = 4, width = 6,
       dpi = 400)
```